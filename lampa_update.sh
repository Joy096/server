#!/bin/bash

# --- ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
SOURCE_DIR="/opt/lampa"                 # üå≥ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–ª–æ–Ω–∞
INSTALL_DIR="/var/www/lampa"            # üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
REPO_URL="https://github.com/yumata/lampa.git" # üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –ì–û–¢–û–í–´–ú–ò —Ñ–∞–π–ª–∞–º–∏
TARGET_BRANCH="main"                    # üéØ –¶–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å)

# --- üöÄ –ù–∞—á–∞–ª–æ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ---
echo "" # –î–æ–±–∞–≤–∏–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤ –≤ –ª–æ–≥–µ
echo "üîÑ [$(date '+%Y-%m-%d %H:%M:%S')] –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Lampa..."

# 1. –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é / –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
if ! cd "${SOURCE_DIR}" &> /dev/null; then
  # echo "‚ÑπÔ∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${SOURCE_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..." # –°–∫—Ä—ã—Ç–æ
  rm -rf "${SOURCE_DIR}"
  git clone --quiet "${REPO_URL}" "${SOURCE_DIR}" || {
    echo "‚ùå [$(date '+%F %T')] –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ${REPO_URL}."
    exit 1
  }
  cd "${SOURCE_DIR}" || {
    echo "‚ùå [$(date '+%F %T')] –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ ${SOURCE_DIR} –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."
    exit 1
  }
fi

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# echo "‚è¨ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–≤–µ—Ç–∫–∞ '${TARGET_BRANCH}')..." # –°–∫—Ä—ã—Ç–æ
git fetch origin || {
  echo "‚ùå [$(date '+%F %T')] –û—à–∏–±–∫–∞: 'git fetch' –Ω–µ —É–¥–∞–ª—Å—è."
  exit 1
}
git reset --hard "origin/${TARGET_BRANCH}" || {
  echo "‚ùå [$(date '+%F %T')] –û—à–∏–±–∫–∞: 'git reset --hard' –Ω–µ —É–¥–∞–ª—Å—è."
  exit 1
}
# –û—á–∏—Å—Ç–∫–∞ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
git clean -fdx

# 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# echo "üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ${INSTALL_DIR} –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..." # –°–∫—Ä—ã—Ç–æ
if [[ -d "${INSTALL_DIR}" ]]; then
  rm -rf "${INSTALL_DIR}"/* || {
    echo "‚ùå [$(date '+%F %T')] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å ${INSTALL_DIR}."
    exit 1
  }
else
  mkdir -p "${INSTALL_DIR}" || {
    echo "‚ùå [$(date '+%F %T')] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å ${INSTALL_DIR}."
    exit 1
  }
fi

shopt -s dotglob # –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
cp -r ./* "${INSTALL_DIR}/" || {
  echo "‚ùå [$(date '+%F %T')] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã."
  shopt -u dotglob # –í—ã–∫–ª—é—á–∞–µ–º –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  exit 1
}
shopt -u dotglob # –í—ã–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
rm -rf "${INSTALL_DIR}/.git" # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ git

# 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
# echo "üîë –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤..." # –°–∫—Ä—ã—Ç–æ
chown -R www-data:www-data "$INSTALL_DIR" &> /dev/null
chmod -R 755 "$INSTALL_DIR" &> /dev/null

# 5. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
echo "‚úÖ [$(date '+%Y-%m-%d %H:%M:%S')] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Lampa –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ."
echo "" # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –ª–æ–≥–∞

exit 0
